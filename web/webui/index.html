<!DOCTYPE html>
<html lang="en">
    <head>
        {{template "head"}}
    </head>
    <body>
        <h1>Admin</h1>
        <p>
            This is the WebUI admin block
        </p>
        <span class="status"></span>

        <h2>Restart mewld</h2>
        <button onclick="restartMewdl()">Restart</button>

        <h2>Add template to webui</h2>
        <button onclick="addTemplate()">Add</button>

        <h2>Remove template to webui</h2>
        <button onclick="removeTemplate()">Remove</button>

        <h2>Reload mewld webui</h2>
        <button onclick="reloadMewdl()">Reload</button>

        <h1>Action Logs</h1>
        <p id="action-logs">Fetching action logs...</p>

        <h1>Clusters</h1>

        <div id="cluster-list">
            {{range $cluster := .InstanceList.Map}}
                <div class="cluster">
                    <p class="cluster-para">{{$cluster.ID}}. {{$cluster.Name}}</p>
                    <div class="cluster-pane" id="c-{{$cluster.ID}}">
                        Loading cluster information...
                    </div>
                </div>
            {{end}}
        </div>
    </body>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
        var instanceMap = null

        async function restartMewdl() {
            let p = prompt("Are you sure you want to restart mewdl (Yes/No)");

            if(p != "Yes") {
                return;
            }

            let res = await fetch("/restart", {
                credentials: "include",
                method: "POST"
            });
            if (res.ok) {
                alert("Restarting mewld");
            } else {
                alert("Failed to restart mewld");
            }
        }

        async function addTemplate() {
            let templName = prompt("Enter template name")

            if (templName) {
                let res = await fetch(`/addtemplate?name=${templName}`, {
                    credentials: "include",
                    method: "POST",
                });
            }
        }

        async function removeTemplate() {
            let templName = prompt("Enter template name")

            if(templName == "head") {
                alert("Cannot remove head template");
                return;
            }

            if (templName) {
                let res = await fetch(`/removetemplate?name=${templName}`, {
                    credentials: "include",
                    method: "POST",
                });
            }
        }

        async function reloadMewdl() {
            let res = await fetch("/reload", {
                credentials: "include",
            });
            if (res.ok) {
                alert("Reloading mewdl");
                window.location.reload()
            } else {
                alert("Failed to reload mewdl");
            }
        }

        let status = "offline"

        function trigger() {
            if(status == "offline") {
                $(".status").text("Offline");
                $(".status").css("color", "red");
            } else if(status == "online") {
                $(".status").text("Online");
                $(".status").css("color", "green");
            } else {
                $(".status").text("Unknown");
                $(".status").css("color", "black");
            }
        }

        function renderInstanceMap() {
            instanceMap.Instances.forEach(i => {
                console.log(i)
            })
        }

        function showAld(i) {
            let el = document.querySelector(`#ald-${i}`)

            if(el.style.display == "none") {
                el.style.display = "initial"
            } else {
                el.style.display = "none"
            }
        }

        async function fetchActionLogs() {
            let res = await fetch("/action-logs", {
                credentials: "include",
            });
            if (res.ok) {
                let data = await res.json();

                let html = ``;

                i = 0

                data.forEach(el => {
                    console.log(el)

                    html += "<div>"

                    switch (el.event) {
                        case "shards_launched":
                            if(!el.cluster && el.cluster != 0) {
                                el.cluster = '<span class="unknown">unknown</span>'
                            }
                            html += `<p class="clickable" onclick="showAld(${i})" id="alp-${i}">Cluster ${el.cluster} launched successfully with shards ${el.from} to ${el.to}</p>`;
                            break;
                    }

                    html += `
                        <div class="ald" style="display: none" id="ald-${i}">
                            <strong>Timestamp: </strong><span class="ts">${new Date(el.ts)}</span>
                        </div>
                    </div>`

                    i++
                })

                $("#action-logs").html(html);
            } else {
                $("#action-logs").html("Failed to fetch action logs");
                console.error("Failed to fetch action logs");
            }
        }

        $(document).ready(function() {
            console.log("Starting connection health timer")

            setInterval(function() {
                const controller = new AbortController()

                // 5 second timeout:
                const timeoutId = setTimeout(() => controller.abort(), 500)


                fetch("/ping", { signal: controller.signal })
                .then(r => {
                    if(r.ok) {
                        status = "online"
                    } else {
                        status = "ping-failed"
                    }

                    trigger()
                })
                .catch(function() {
                    status = "offline"
                    trigger()
                })
            }, 3000);

            // Fetch instance map
            fetch("/instance-list", { credentials: "include" })
            .then(r => r.json())
            .then(r => instanceMap = r)
            .then(_ => {
                // Render cluster view
                renderInstanceMap()
                // Fetch action logs
                fetchActionLogs()
            })
        });
    </script>
</html>